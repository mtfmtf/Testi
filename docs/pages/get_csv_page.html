
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CSV → klickbare Konferenzliste</title>
<style>
  body { font-family: system-ui,Segoe UI,Roboto,Helvetica,Arial; padding:20px; }
  .container { display:flex; gap:20px; align-items:flex-start; }
  #list { width:280px; max-height:60vh; overflow:auto; border:1px solid #ccc; padding:8px; list-style:none; margin:0; }
  #list li { padding:8px; border-radius:4px; cursor:pointer; margin-bottom:6px; }
  #list li:hover { background:#f0f0f0; }
  #list li.selected { background:#e0f0ff; border:1px solid #80bfff; }
  #details { flex:1; border:1px solid #ccc; padding:12px; min-height:120px; }
  .meta { color:#666; margin-top:8px; }
  a.link { word-break:break-all; display:inline-block; margin-top:8px; }
</style>
</head>


<body>


<script>
document.addEventListener("DOMContentLoaded", () => {
  loadCSV("csv/test-list2.csv");
});

function loadCSV(path) {
  fetch(path)
    .then(response => {
      if (!response.ok) {
        throw new Error("CSV konnte nicht geladen werden");
      }
      return response.text();
    })
    .then(text => {
      parseCSV(text);
    })
    .catch(err => {
      console.error(err);
      document.getElementById("list").innerHTML =
        "<li style='color:red'>Fehler beim Laden der CSV.</li>";
    });
}
// --- Utility: robuster CSV-Parser (behandelt Anführungszeichen und Kommas in Feldern) ---

function parseCSV(text) {
  const rows = [];
  let cur = '', row = [], inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    const next = text[i+1];

    if (ch === '"' ) {
      if (inQuotes && next === '"') { // escaped quote
        cur += '"'; i++; // skip one quote, add one
      } else {
        inQuotes = !inQuotes; // toggle inQuotes
      }
      continue;
    }

    if (ch === ',' && !inQuotes) {
      row.push(cur);
      cur = '';
      continue;
    }

    if ((ch === '\n' || ch === '\r') && !inQuotes) {
      // handle CRLF and solitary CR or LF
      if (cur !== '' || row.length > 0) {
        row.push(cur);
        rows.push(row);
        row = [];
        cur = '';
      }
      // skip possible \n after \r
      if (ch === '\r' && text[i+1] === '\n') i++;
      continue;
    }

    cur += ch;
  }
  // push last cell/row if present
  if (cur !== '' || row.length > 0) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

// --- Funktion: CSV-Text in Array von Objekten verwandeln ---
function csvToObjects(text) {
  const rows = parseCSV(text).filter(r => r.length > 0);
  if (rows.length === 0) return [];
  const headers = rows[0].map(h => h.trim());
  const data = [];
  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    // pad row if shorter than headers
    const obj = {};
    for (let j = 0; j < headers.length; j++) {
      obj[headers[j]] = (row[j] !== undefined) ? row[j].trim() : '';
    }
    // skip entirely empty rows
    if (Object.values(obj).some(v => v !== '')) data.push(obj);
  }
  return data;
}

// --- DOM & Verhalten ---
const input = document.getElementById('csvInput');
const listEl = document.getElementById('list');
const detailsEl = document.getElementById('details');
let currentSelectedLi = null;

input.addEventListener('change', (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const text = reader.result;
      const data = csvToObjects(text);

      // Erwartete Header: Name, Beschreibung, Deadline, Ort, Webseitenlink
      // Falls die CSV andere Header hat, passe die Namen an oder benutze indices.

      // Leere Liste füllen
      listEl.innerHTML = '';
      if (data.length === 0) {
        listEl.innerHTML = '<li style="color:#888;">Keine Einträge gefunden.</li>';
        detailsEl.innerHTML = '<strong>Keine Daten.</strong>';
        return;
      }

      data.forEach((item, idx) => {
        const name = item['Name'] ?? item['name'] ?? item['NAME'] ?? 'Unnamed';
        const li = document.createElement('li');
        li.textContent = name;
        li.dataset.index = idx; // für Zugriff auf data
        li.addEventListener('click', () => {
          // Auswahl markieren
          if (currentSelectedLi) currentSelectedLi.classList.remove('selected');
          li.classList.add('selected');
          currentSelectedLi = li;
          showDetails(item);
        });
        listEl.appendChild(li);
      });

      // optional: automatisch ersten Eintrag auswählen
      // listEl.querySelector('li').click();
      detailsEl.innerHTML = '<strong>Wähle einen Eintrag aus der Liste.</strong>';
      // speichern data im list Element für späteren Zugriff
      listEl._csvData = data;

    } catch (err) {
      detailsEl.innerHTML = '<strong style="color:red">Fehler beim Einlesen der CSV.</strong><div class="meta">'+err.message+'</div>';
    }
  };
  reader.onerror = () => {
    detailsEl.innerHTML = '<strong style="color:red">Fehler: Datei konnte nicht gelesen werden.</strong>';
  };
  reader.readAsText(file, 'utf-8');
});

function showDetails(item) {
  // sichere Feldzugriffe: versuche mehrere mögliche Header-Varianten
  const name = item['Name'] ?? item['name'] ?? item['NAME'] ?? '';
  const besch = item['Beschreibung'] ?? item['beschreibung'] ?? item['Beschreibung'] ?? item['Beschreibung'] ?? '';
  const deadline = item['Deadline'] ?? item['deadline'] ?? '';
  const ort = item['Ort'] ?? item['ort'] ?? '';
  const link = item['Webseitenlink'] ?? item['webseitenlink'] ?? item['Link'] ?? item['link'] ?? '';

  // Erzeuge HTML für das Detailfeld
  const html = `
    <h2 style="margin-top:0">${escapeHtml(name)}</h2>
    <div class="meta"><strong>Deadline:</strong> ${escapeHtml(deadline)}</div>
    <div style="margin-top:10px"><strong>Beschreibung:</strong><div>${nl2br(escapeHtml(besch))}</div></div>
    <div class="meta" style="margin-top:8px"><strong>Ort:</strong> ${escapeHtml(ort)}</div>
    ${ link ? `<a class="link" href="${escapeAttribute(link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(link)}</a>` : '' }
  `;
  detailsEl.innerHTML = html;
}

// kleine Sicherheits-Helper (HTML-escaping)
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  })[s]);
}
function escapeAttribute(s) { return escapeHtml(s).replace(/"/g,'&quot;'); }
function nl2br(s) { return s.replace(/\n/g,'<br>'); }

</script>

<div class="container" style="margin-top:16px;">
  <ul id="list"><li style="color:#888;">Keine Datei geladen.</li></ul>
  <div id="details">
    <strong>Details erscheinen hier nach Klick auf einen Eintrag.</strong>
  </div>
</div>
</body>
</html>
